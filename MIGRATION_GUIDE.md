# Руководство по миграции на Мультитенантность и Систему Прав

## Обзор изменений

Проект ToolManager был обновлен с внедрением:

1. **Мультитенантности (Multi-tenancy)** - изоляция данных по компаниям
2. **Системы ролей и прав доступа** - гранулярные права вместо простой системы ADMIN/EMPLOYEE
3. **Системы приглашений** - приглашение сотрудников по email
4. **Новых эндпоинтов для transfer/checkin** - улучшенная работа с инструментами

## Основные изменения в базе данных

### Новые модели

- **Company** - компания (для изоляции данных)
- **Role** - кастомная роль с массивом прав
- **Invitation** - приглашение сотрудников
- **Permission** (enum) - гранулярные права доступа

### Обновленные модели

- **User**: 
  - Добавлено `companyId` (обязательное)
  - Добавлено `roleId` (опциональное)
  - ID теперь `String` (cuid) вместо `Int`

- **Tool**:
  - Добавлено `companyId` (обязательное)
  - Добавлено `imageUrl` (опциональное)
  - `currentOwnerId` → `currentUserId`
  - ID теперь `String` (cuid) вместо `Int`
  - `status` теперь `String` вместо enum

- **ToolHistory**:
  - Добавлено `actorId` - кто инициировал действие
  - Добавлено `action` - тип действия (TRANSFER/CHECK_IN)
  - ID теперь `String` (cuid) вместо `Int`

## Права доступа (Permissions)

```
USER_INVITE       - Приглашать пользователей
USER_DELETE       - Удалять пользователей
USER_READ         - Видеть список пользователей
USER_ASSIGN_ROLE  - Назначать роли

ROLE_MANAGE       - Управлять ролями (только Босс)

TOOL_CREATE       - Создавать инструменты
TOOL_UPDATE       - Редактировать инструменты
TOOL_DELETE       - Удалять инструменты
TOOL_READ         - Видеть список инструментов

TOOL_TRANSFER     - Передавать инструменты
TOOL_CHECKIN      - Принимать инструменты на склад
```

## Новые API эндпоинты

### Роли
- `GET /api/roles` - Список ролей компании (только Босс)
- `POST /api/roles` - Создать роль (только Босс)
- `PUT /api/roles/:id` - Обновить роль (только Босс)
- `DELETE /api/roles/:id` - Удалить роль (только Босс)
- `PUT /api/roles/assign/:userId` - Назначить роль (право USER_ASSIGN_ROLE)

### Приглашения
- `POST /api/invitations` - Создать приглашение (право USER_INVITE)
- `GET /api/invitations` - Список приглашений (право USER_INVITE)
- `DELETE /api/invitations/:id` - Удалить приглашение (право USER_INVITE)
- `GET /api/invitations/public/:token` - Получить информацию о приглашении (публично)

### Инструменты (новые)
- `POST /api/tools/:id/transfer` - Передать инструмент (право TOOL_TRANSFER)
- `POST /api/tools/:id/checkin` - Вернуть на склад (право TOOL_CHECKIN)

## Обновленные эндпоинты

### Аутентификация
- `POST /api/auth/register` теперь принимает:
  - `companyName` (для создания новой компании)
  - `inviteToken` (для регистрации по приглашению)

### Инструменты
- Все эндпоинты теперь требуют соответствующие права (TOOL_READ, TOOL_CREATE, etc.)
- Добавлена изоляция по `companyId`

### Пользователи
- `DELETE /api/users/:id` - Удалить пользователя (право USER_DELETE)
- Убран эндпоинт `PUT /api/users/role/:id` (используйте `/api/roles/assign/:userId`)

## Процесс регистрации

### Создание новой компании
1. Пользователь переходит на `/register`
2. Заполняет форму с полем "Название компании"
3. Создается:
   - Компания
   - Роль "Босс" со всеми правами
   - Пользователь с ролью "Босс"

### Регистрация по приглашению
1. Босс создает приглашение через `/api/invitations` с email
2. Пользователь переходит по ссылке `/register?invite=TOKEN`
3. Форма автоматически заполняет email
4. Создается пользователь в указанной компании

## Frontend изменения

### Обновленный authStore
```javascript
const { 
  user,           // Объект пользователя с полем role
  isBoss,         // Флаг Босса
  permissions,    // Массив прав
  hasPermission,  // Функция проверки права
  hasAnyPermission // Функция проверки любого из прав
} = useAuthStore();
```

### Новые компоненты маршрутизации
- `<BossRoute>` - только для Босса
- `<PermissionRoute permission="TOOL_READ">` - для конкретного права
- `<PermissionRoute anyOf={['TOOL_READ', 'TOOL_UPDATE']}>` - любое из прав

### Новые страницы
- `/roles` - Управление ролями (только Босс)

## Как начать работу

### 1. Обновите базу данных
```bash
cd backend
npx prisma db push
npx prisma generate
```

### 2. Запустите PostgreSQL (если используете Docker)
```bash
docker compose up -d
```

### 3. Запустите backend
```bash
cd backend
npm install
npm run dev
```

### 4. Запустите frontend
```bash
cd frontend
npm install
npm run dev
```

### 5. Зарегистрируйте первую компанию
- Перейдите на http://localhost:5173/register
- Заполните форму с названием компании
- Вы получите роль Босса со всеми правами

## Миграция существующих данных

Если у вас есть существующие данные, вам нужно:

1. Создать компанию по умолчанию
2. Создать роль "Босс" с всеми правами
3. Связать всех существующих пользователей с этой компанией
4. Назначить ADMIN пользователям роль "Босс"
5. Связать все инструменты с компанией

**Примечание:** Из-за изменения типов ID (Int → String), рекомендуется начать с чистой базы данных.

## Важные замечания

- ID всех моделей теперь `String` (cuid) вместо `Int`
- Все API запросы автоматически фильтруются по `companyId` текущего пользователя
- Нельзя удалить роль "Босс" или пользователя с ролью "Босс"
- Нельзя удалить роль, к которой привязаны пользователи
- Приглашения истекают через 7 дней (по умолчанию)
