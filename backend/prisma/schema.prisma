// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum для гранулярных прав доступа
enum Permission {
  // Управление пользователями
  USER_INVITE       // Приглашать пользователей
  USER_DELETE       // Удалять пользователей
  USER_READ         // Видеть список пользователей
  USER_ASSIGN_ROLE  // Назначать роли

  // Управление ролями (только для Босса)
  ROLE_MANAGE       // Создавать, редактировать, удалять роли

  // Управление инструментами
  TOOL_CREATE       // Создавать инструмент
  TOOL_UPDATE       // Редактировать инфо об инструменте (вкл. фото)
  TOOL_DELETE       // Удалять инструмент
  TOOL_READ         // Видеть список инструментов

  // Прием-Передача
  TOOL_TRANSFER     // Передавать инструмент другому сотруднику
  TOOL_CHECKIN      // Принимать инструмент "на склад" (возврат)

  // Управление складами
  WAREHOUSE_CREATE  // Создавать склад
  WAREHOUSE_UPDATE  // Редактировать склад
  WAREHOUSE_DELETE  // Удалять склад
  WAREHOUSE_READ    // Видеть список складов
}

// Модель компании (для изоляции пользователей и инструментов)
model Company {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  users       User[]
  tools       Tool[]
  roles       Role[]
  invitations Invitation[]
  warehouses  Warehouse[]
}

// Модель роли (кастомная, управляемая)
model Role {
  id          String       @id @default(cuid())
  name        String
  companyId   String
  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Массив прав доступа
  permissions Permission[]
  
  users       User[]
  invitations Invitation[]
  isBoss      Boolean      @default(false) // Специальный флаг для роли "Босса"
  createdAt   DateTime     @default(now())

  @@unique([companyId, name])
}

// Модель пользователя (сотрудника)
model User {
  id        String   @id @default(cuid())
  email     String   @unique // Логин
  password  String   // Хэшированный пароль
  name      String
  createdAt DateTime @default(now())

  // Привязка к компании
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Привязка к роли
  roleId    String?
  role      Role?   @relation(fields: [roleId], references: [id], onDelete: SetNull)

  // Инструменты, которые сейчас у пользователя
  currentTools    Tool[]        @relation("CurrentToolUser")

  // История действий с инструментами
  historyActions  ToolHistory[] @relation("HistoryActor")
  historyFrom     ToolHistory[] @relation("HistoryFromUser")
  historyTo       ToolHistory[] @relation("HistoryToUser")
}

// Модель приглашений сотрудников
model Invitation {
  id        String   @id @default(cuid())
  token     String   @unique // Уникальный токен приглашения
  email     String   // Email приглашенного сотрудника
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  roleId    String?  // Роль, которая будет назначена при регистрации (опционально)
  role      Role?    @relation(fields: [roleId], references: [id], onDelete: SetNull)
  
  expiresAt DateTime // Срок действия приглашения
  usedAt    DateTime? // Когда было использовано (null = не использовано)
  createdAt DateTime @default(now())
}

// Модель склада
model Warehouse {
  id        String   @id @default(cuid())
  name      String
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  isDefault Boolean  @default(false) // Флаг дефолтного склада
  createdAt DateTime @default(now())

  tools     Tool[]
  historyFrom ToolHistory[] @relation("HistoryFromWarehouse")
  historyTo   ToolHistory[] @relation("HistoryToWarehouse")

  @@unique([companyId, name])
}

// Модель инструмента
model Tool {
  id           String   @id @default(cuid())
  name         String   // Название (н.п. "Дрель Makita XF-200")
  serialNumber String   // Серийный номер
  description  String?
  imageUrl     String?  // URL изображения инструмента
  status       String   @default("AVAILABLE") // "AVAILABLE" (на складе), "IN_USE" (у сотрудника)
  createdAt    DateTime @default(now())

  // Привязка к компании
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Текущий владелец (null = на складе)
  currentUserId String?
  currentUser   User?   @relation("CurrentToolUser", fields: [currentUserId], references: [id], onDelete: SetNull)

  // Склад, на котором находится инструмент (если не у пользователя)
  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  // История перемещений
  history ToolHistory[]

  @@unique([companyId, serialNumber])
}

// Модель для отслеживания истории перемещений инструментов
model ToolHistory {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  toolId String
  tool   Tool   @relation(fields: [toolId], references: [id], onDelete: Cascade)

  // Кто инициировал действие
  actorId String
  actor   User   @relation("HistoryActor", fields: [actorId], references: [id])

  // Тип действия: "TRANSFER" (передача), "CHECK_IN" (возврат на склад)
  action  String

  // Кто был предыдущим владельцем (если был)
  fromUserId String?
  fromUser   User?   @relation("HistoryFromUser", fields: [fromUserId], references: [id])

  // Кто стал новым владельцем (если стал)
  toUserId String?
  toUser   User?   @relation("HistoryToUser", fields: [toUserId], references: [id])

  // Склад, откуда был взят инструмент
  fromWarehouseId String?
  fromWarehouse   Warehouse? @relation("HistoryFromWarehouse", fields: [fromWarehouseId], references: [id])

  // Склад, куда был передан инструмент
  toWarehouseId String?
  toWarehouse   Warehouse? @relation("HistoryToWarehouse", fields: [toWarehouseId], references: [id])

  // Примечание (опционально)
  notes String?
}
